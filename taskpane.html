<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Google Maps in Task Pane</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS8L-j2sIfptPCLDUIMP3314KPrKq4394&libraries=places"></script>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #search-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            z-index: 5;
            display: flex;
        }
        #search-input {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        #search-button {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <div id="search-bar">
        <input id="search-input" type="text" placeholder="Search location or coordinates">
        <button id="search-button">Search</button>
    </div>
    <div id="map"></div>

    <script>
        let map;
        let currentMarker;  // Store the current marker to remove it when a new one is added

        function initMap() {
            // Center on Muscat
            const muscat = { lat: 23.5859, lng: 58.4059 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: muscat,
                mapTypeId: google.maps.MapTypeId.SATELLITE,
            });

            // Add double-click listener to place a marker and update coordinates in Excel
            map.addListener("dblclick", (event) => {
                placeMarker(event.latLng.lat(), event.latLng.lng());
            });
        }

        // Function to place a marker and set coordinates in Excel
        function placeMarker(lat, lng) {
            // Remove the previous marker if it exists
            if (currentMarker) {
                currentMarker.setMap(null);
            }

            // Place a new marker at the specified location
            currentMarker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
            });

            // Call Office.js to set the values in Excel
            Office.onReady(() => {
                Excel.run((context) => {
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    sheet.getRange("B1").values = [[lat]];
                    sheet.getRange("B2").values = [[lng]];
                    return context.sync();
                }).catch((error) => console.error(error));
            });
        }

        // Function to search for a location or coordinates
        document.getElementById("search-button").addEventListener("click", () => {
            const searchInput = document.getElementById("search-input").value.trim();

            if (searchInput) {
                // Use Google Places API to find the location
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: searchInput }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        placeMarker(location.lat(), location.lng());
                    } else {
                        alert("Location not found. Try coordinates or a different search.");
                    }
                });
            }
        });

        // Load the map after Office.js and the page are ready
        Office.onReady(initMap);
    </script>
</body>
</html>
