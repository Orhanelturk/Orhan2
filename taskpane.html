<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Size Calculator</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #app {
            width: 300px;
        }

        h1, h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 5px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }

        #summaryPanel {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Battery Size Calculator</h1>
        <div class="input-group">
            <label for="solarCapacity">Solar Capacity (kW):</label>
            <input type="number" id="solarCapacity" placeholder="Enter solar capacity">
        </div>
        <div class="input-group">
            <label for="batterySize">Battery Size (kW):</label>
            <input type="number" id="batterySize" placeholder="Enter battery size">
        </div>
        <div class="input-group">
            <label for="batteryCapacity">Battery Capacity (kWh):</label>
            <input type="number" id="batteryCapacity" placeholder="Enter battery capacity">
        </div>
        <div class="input-group">
            <label for="dod">Depth of Discharge (DOD %):</label>
            <input type="number" id="dod" placeholder="Enter DOD percentage">
        </div>
        <div class="input-group">
            <label for="rte">Battery RTE (%):</label>
            <input type="number" id="rte" placeholder="Enter RTE percentage">
        </div>
        <div class="button-group">
            <button id="calculateButton">Calculate</button>
            <button id="resetButton">Reset</button>
        </div>
        <div id="summaryPanel">
            <h2>Summary</h2>
            <p id="powerWasted">Power wasted: <span>0</span> kW</p>
            <p id="totalOutput">Total system output: <span>0</span> kW</p>
        </div>
    </div>
    <script>
        Office.onReady(() => {
            document.getElementById('calculateButton').addEventListener('click', calculateBatteryUsage);
            document.getElementById('resetButton').addEventListener('click', resetInputs);
        });

        async function calculateBatteryUsage() {
            const solarCapacity = parseFloat(document.getElementById('solarCapacity').value);
            const batterySize = parseFloat(document.getElementById('batterySize').value);
            const batteryCapacity = parseFloat(document.getElementById('batteryCapacity').value);
            const dod = parseFloat(document.getElementById('dod').value) / 100;
            const rte = parseFloat(document.getElementById('rte').value) / 100;

            const actualBatteryCapacity = batteryCapacity * dod * rte;

            await Excel.run(async (context) => {
                const sheet = context.workbook.worksheets.getActiveWorksheet();
                const loadRange = sheet.getRange("B2:B8761");
                const solarRange = sheet.getRange("C2:C8761");

                loadRange.load("values");
                solarRange.load("values");
                await context.sync();

                const adjustedSolarProduction = solarRange.values.map(value => value[0] * solarCapacity);
                let batterySOC = 0;
                let wastedPower = 0;
                let totalSystemOutput = 0;

                const batteryActivity = [];
                const batterySOCValues = [];
                const wastedPowerValues = [];
                const totalOutputValues = [];

                for (let i = 0; i < loadRange.values.length; i++) {
                    const load = loadRange.values[i][0];
                    const solar = adjustedSolarProduction[i];
                    let batteryUsed = 0;
                    let wasted = 0;

                    if (solar > load) {
                        const excessPower = solar - load;
                        const chargePower = Math.min(excessPower, batterySize);
                        const chargeEnergy = chargePower * rte;
                        if (batterySOC + chargeEnergy <= actualBatteryCapacity) {
                            batterySOC += chargeEnergy;
                            batteryUsed = -chargePower;
                        } else {
                            wasted = excessPower - chargePower;
                        }
                    } else {
                        const deficitPower = load - solar;
                        const dischargePower = Math.min(deficitPower, batterySize);
                        if (batterySOC - dischargePower >= 0) {
                            batterySOC -= dischargePower;
                            batteryUsed = dischargePower;
                        } else {
                            wasted = deficitPower - dischargePower;
                        }
                    }

                    wastedPower += wasted;
                    totalSystemOutput += (solar + batteryUsed);
                    batteryActivity.push(batteryUsed);
                    batterySOCValues.push(batterySOC);
                    wastedPowerValues.push(wasted);
                    totalOutputValues.push(solar + batteryUsed);
                }

                sheet.getRange("D2:D8761").values = adjustedSolarProduction.map(v => [v]);
                sheet.getRange("E2:E8761").values = batteryActivity.map(v => [v]);
                sheet.getRange("F2:F8761").values = batterySOCValues.map(v => [v]);
                sheet.getRange("G2:G8761").values = wastedPowerValues.map(v => [v]);
                sheet.getRange("H2:H8761").values = totalOutputValues.map(v => [v]);

                await context.sync();

                document.getElementById('powerWasted').querySelector('span').textContent = wastedPower.toFixed(2);
                document.getElementById('totalOutput').querySelector('span').textContent = totalSystemOutput.toFixed(2);
            });
        }

        function resetInputs() {
            document.getElementById('solarCapacity').value = '';
            document.getElementById('batterySize').value = '';
            document.getElementById('batteryCapacity').value = '';
            document.getElementById('dod').value = '';
            document.getElementById('rte').value = '';
            document.getElementById('powerWasted').querySelector('span').textContent = '0';
            document.getElementById('totalOutput').querySelector('span').textContent = '0';
        }
    </script>
</body>
</html>
